{
  "entities": {
    "UserProfile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserProfile",
      "type": "object",
      "description": "Represents a user's profile information.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user profile."
        },
        "email": {
          "type": "string",
          "description": "User's email address.",
          "format": "email"
        },
        "name": {
          "type": "string",
          "description": "User's full name."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the user profile was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the user profile was last updated.",
          "format": "date-time"
        },
        "quizzesGenerated": {
          "type": "number",
          "description": "The total number of quizzes generated by the user."
        },
        "totalMcqsAttempted": {
          "type": "number",
          "description": "The total number of MCQs the user has attempted across all quizzes."
        },
        "totalMcqsCorrect": {
          "type": "number",
          "description": "The total number of MCQs the user has answered correctly."
        }
      },
      "required": [
        "id",
        "email",
        "name",
        "createdAt",
        "updatedAt"
      ]
    },
    "MCQ": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "MCQ",
      "type": "object",
      "description": "Represents a multiple-choice question.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the MCQ."
        },
        "level": {
          "type": "string",
          "description": "The level of the MCQ (Foundation, Intermediate, Final)."
        },
        "group": {
          "type": "string",
          "description": "The group of the MCQ (Group I, Group II). Applicable for Intermediate and Final levels."
        },
        "subject": {
          "type": "string",
          "description": "The subject of the MCQ."
        },
        "difficulty": {
          "type": "string",
          "description": "The difficulty level of the MCQ (Easy, Medium, Hard)."
        },
        "question": {
          "type": "string",
          "description": "The text of the question."
        },
        "options": {
          "type": "array",
          "description": "The options for the question.",
          "items": {
            "type": "string"
          }
        },
        "correctAnswer": {
          "type": "string",
          "description": "The correct answer to the question."
        },
        "explanation": {
          "type": "string",
          "description": "Explanation for the correct answer."
        },
        "uploadedFileId": {
          "type": "string",
          "description": "Reference to UploadedFile. (Relationship: UploadedFile 1:N MCQ). It is null if the question generated from syllabus."
        }
      },
      "required": [
        "id",
        "level",
        "subject",
        "difficulty",
        "question",
        "options",
        "correctAnswer",
        "explanation"
      ]
    },
    "UploadedFile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UploadedFile",
      "type": "object",
      "description": "Represents a file uploaded by the user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the uploaded file."
        },
        "userId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:N UploadedFile)"
        },
        "filename": {
          "type": "string",
          "description": "The original name of the uploaded file."
        },
        "url": {
          "type": "string",
          "description": "The URL where the file is stored."
        },
        "uploadDate": {
          "type": "string",
          "description": "Timestamp indicating when the file was uploaded.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "filename",
        "url",
        "uploadDate"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "UserProfile",
          "schema": {
            "$ref": "#/backend/entities/UserProfile"
          },
          "description": "Stores user profile information. Accessible only to the authenticated user.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/uploadedFiles/{fileId}",
        "definition": {
          "entityName": "UploadedFile",
          "schema": {
            "$ref": "#/backend/entities/UploadedFile"
          },
          "description": "Stores files uploaded by the user. Only the owning user can access these files.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "fileId",
              "description": "The unique identifier of the uploaded file."
            }
          ]
        }
      },
      {
        "path": "/mcqs_foundation/{mcqId}",
        "definition": {
          "entityName": "MCQ",
          "schema": {
            "$ref": "#/backend/entities/MCQ"
          },
          "description": "Stores multiple-choice questions for the Foundation level.  Consider adding roles for admin/editor access if needed.",
          "params": [
            {
              "name": "mcqId",
              "description": "The unique identifier of the MCQ."
            }
          ]
        }
      },
      {
        "path": "/mcqs_intermediate/{mcqId}",
        "definition": {
          "entityName": "MCQ",
          "schema": {
            "$ref": "#/backend/entities/MCQ"
          },
          "description": "Stores multiple-choice questions for the Intermediate level.  Consider adding roles for admin/editor access if needed.",
          "params": [
            {
              "name": "mcqId",
              "description": "The unique identifier of the MCQ."
            }
          ]
        }
      },
      {
        "path": "/mcqs_final/{mcqId}",
        "definition": {
          "entityName": "MCQ",
          "schema": {
            "$ref": "#/backend/entities/MCQ"
          },
          "description": "Stores multiple-choice questions for the Final level.  Consider adding roles for admin/editor access if needed.",
          "params": [
            {
              "name": "mcqId",
              "description": "The unique identifier of the MCQ."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to store user profiles, uploaded files, and multiple-choice questions (MCQs) for a CA Exam Prep application. The design emphasizes authorization independence, clarity, and structural segregation to enable robust security rules and efficient data retrieval. User profiles are stored in a dedicated collection, with uploaded files and MCQs stored in subcollections, enforcing ownership and facilitating secure list operations. All data related to MCQs for different levels (Foundation, Intermediate, Final) are stored in separate collections to make security rules easier to manage and enforce.\n\n**Authorization Independence (CRITICAL):**\n\n*   UserProfile: User profiles are stored directly at `/users/{userId}`, allowing straightforward access control based on `request.auth.uid == userId`.\n*   UploadedFile: Uploaded files are stored within user-specific subcollections `/users/{userId}/uploadedFiles/{fileId}`, inheriting authorization context from the parent user profile. This ensures only the owning user can access these files.\n*   MCQ: MCQs are stored in separate collections, `/mcqs_foundation`, `/mcqs_intermediate`, and `/mcqs_final`. Authorization rules can be based on the absence of roles, assuming all users can access the MCQs, or can be extended to allow only specific roles or admins to create/modify them. The `uploadedFileId` property within the `MCQ` document links back to the file from which the question was potentially generated, providing a reference for tracing.\n\n**Structural Segregation (Homogeneous Security Posture):**\n\n*   User profiles are separated from uploaded files and MCQs, stored in their respective collections. This segregation allows distinct security rules for each data type, preventing unintended access.\n*   MCQs are further segregated by exam level (foundation, intermediate, final), facilitating distinct security rules tailored to each level.\n\n**QAPs (Rules are not Filters):**\n\n*   Path-based ownership for uploaded files (`/users/{userId}/uploadedFiles/{fileId}`) allows secure list operations, as rules can easily filter based on the user ID in the path.\n*   Segregation of MCQs by exam level supports secure list operations, as queries can be limited to a specific collection based on the level.\n\n**Invariants:**\n\n*   The `userId` field in `UploadedFile` maintains the invariant of ownership, as it must match the `userId` in the path. Timestamps (`createdAt`, `updatedAt`, `uploadDate`) are enforced through rules, ensuring data integrity.\n\nThis structure supports the required QAPs by using structural segregation and path-based ownership for uploaded files. The segregation of MCQs by exam level allows secure list operations, and the path-based ownership for uploaded files further simplifies secure data access and management."
  }
}
    